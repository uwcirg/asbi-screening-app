
/**
 * Parses a Questionnaire and determines what value choice (value[x]) each of its items are.
 * @param {object} allOrPartQuestionnaire - A FHIR Questionnaire or a subset of its items
 * @param {array} typeHash - An array containing the value choice (value[x]) for each item
 * @returns {array} typeHash - An array containing the value choice (value[x]) for each item
 */
export function getItemTypes(allOrPartQuestionnaire, typeHash) {
  let items = allOrPartQuestionnaire.item;
  items.forEach(itm => {
    if (itm.type == 'group'){
      typeHash = getItemTypes(itm, typeHash); // recursive function call
    } else if (itm.type == 'boolean') {
      typeHash[itm.linkId] = 'valueBoolean';
    } else {
      typeHash[itm.linkId] = 'valueString'
    }
  });
  return typeHash;
}

export function getCurrentISODate() {
  let now = new Date(Date.now()); // Date.now() returns [millisecods]
  let timeZoneCorrection = now.getTimezoneOffset() * 60 * 1000; // [minutes] * [seconds/minutes] * [milliseconds/second]
  let correctedDate = new Date(now.getTime() - timeZoneCorrection);
  return correctedDate.toISOString().split('T')[0]; // just the date portion
}

export function capitalizeFirstLetter(text) {
  if (!text) return '';
  return text[0].toUpperCase() + text.substring(1);
}

export function getObservationCategories() {
  return [
    'social-history',
    'vital-signs',
    'imaging',
    'laboratory',
    'procedure',
    'survey',
    'exam',
    'therapy',
    'activity'
  ]
}

export function getResponseValue(questionnaire, linkId, response) {
  let responseValue = {};
  let questionItemIndex = questionnaire.item.findIndex(itm => itm.linkId == linkId);
  let item = questionnaire.item[questionItemIndex];
  if (item.type == 'choice') {
    let answerOptionIndex = item.answerOption.findIndex(itm => {
      if (itm.valueString && itm.valueString == response) return true;
      if (itm.valueCoding && itm.valueCoding.display == response) return true;
      return false;
    });
    if (item.answerOption[answerOptionIndex].valueString) {
      responseValue.type = 'valueString';
      responseValue.value = response;
    } else if (item.answerOption[answerOptionIndex].valueCoding) {
      responseValue.type = 'valueCoding';
      responseValue.value = item.answerOption[answerOptionIndex].valueCoding;
    } // TODO: ELSE THROW ERROR
  } else if (item.type == 'boolean') {
    responseValue.type = 'valueBoolean';
    responseValue.value = response;
  }
  else if (item.type == 'decimal') {
    responseValue.type = 'valueDecimal';
    responseValue.value = !isNaN(response) ? parseFloat(response) : response;
  } else {
    responseValue.type = 'valueCoding';    
    responseValue.value = { display: response };
  }

  return responseValue;

}

export function getFHIRResourcePaths(patientId) {
  if (!patientId) return [];
  let resources = process.env.VUE_APP_FHIR_RESOURCES ? process.env.VUE_APP_FHIR_RESOURCES.split(',') : [];
  return resources.map(resource => {
    let path = `/${resource}?patient=${patientId}`;
    if (resource.toLowerCase() === "observation" &&
      process.env.VUE_APP_FHIR_OBSERVATION_CATEGORY_QUERIES &&
      process.env.VUE_APP_FHIR_OBSERVATION_CATEGORY_QUERIES.toLowerCase() === 'true'){
      path  = path + '&' + encodeURIComponent((getObservationCategories().map(cat => 'category=' + cat)).join('&'));
    }
    return path;
  });
}
